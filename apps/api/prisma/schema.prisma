// Prisma schema for Texnika.kz marketplace
// Datasource & generator configuration

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  USER
  DEALER
  MODERATOR
  ADMIN
}

enum ListingStatus {
  DRAFT
  PENDING
  PUBLISHED
  REJECTED
  HIDDEN
  ARCHIVED
  BLOCKED
}

enum SellerType {
  PRIVATE
  DEALER
}

enum DealType {
  SALE
  RENT
  LEASING
}

enum PromotionType {
  VIP
  TOP
  HIGHLIGHT
  AUTOBUMP
}

enum PricingPlanCode {
  VIP
  TOP
  HIGHLIGHT
}

enum PromotionSubjectType {
  LISTING
  SPECIALIST
}

enum PromotionActivationStatus {
  ACTIVE
  EXPIRED
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  FAILED
}

enum BillingProvider {
  MOCK
}

enum TransactionType {
  DEBIT
  CREDIT
  REFUND
  ADJUST
}

enum SpecialistAvailability {
  FULL_TIME
  PART_TIME
  SHIFT
  TRAVEL
}

enum MediaKind {
  IMAGE
  VIDEO
  DOCUMENT
}

enum SpecialistPromotionType {
  VIP
  TOP
  HIGHLIGHT
  AUTOBUMP
}

model User {
  id            String          @id @default(cuid())
  role          UserRole        @default(USER)
  phone         String          @unique
  email         String?         @unique
  passwordHash  String?
  firstName     String?
  lastName      String?
  avatarUrl     String?
  isVerified    Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  lastLoginAt   DateTime?
  dealer        Dealer?         @relation("DealerMembers", fields: [dealerId], references: [id])
  dealerId      String?
  listings      Listing[]
  specialists   Specialist[]
  reviews       Review[]        @relation("ReviewAuthor")
  conversations Conversation[]  @relation("ConversationBuyer")
  deals         Conversation[]  @relation("ConversationSeller")
  messages      Message[]
  favorites     Favorite[]
  orders        Order[]
  wallet        Wallet?
}

model Dealer {
  id           String        @id @default(cuid())
  name         String
  slug         String        @unique
  innIin       String?
  description  String?
  website      String?
  addresses    Json?
  logoKey      String?
  plan         DealerPlan    @default(FREE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  members      User[]        @relation("DealerMembers")
  listings     Listing[]
}

enum DealerPlan {
  FREE
  PRO
  ENTERPRISE
}

model Region {
  id        String   @id @db.VarChar(64)
  name      String
  slug      String   @unique @db.VarChar(64)
  createdAt DateTime @default(now())
  cities    City[]
}

model City {
  id        String   @id @db.VarChar(64)
  name      String
  slug      String   @unique @db.VarChar(64)
  regionId  String
  region    Region   @relation(fields: [regionId], references: [id])
  createdAt DateTime @default(now())
  listings  Listing[]
  specialists Specialist[]
  @@index([regionId])
}

model Category {
  id          String    @id @db.VarChar(64)
  name        String
  description String?
  createdAt   DateTime  @default(now())
  listings    Listing[]
  specialists Specialist[]
}

model Listing {
  id             String         @id @default(cuid())
  status         ListingStatus  @default(DRAFT)
  dealType       DealType       @default(SALE)
  categoryId     String
  category       Category       @relation(fields: [categoryId], references: [id])
  title          String
  slug           String         @unique
  description    String
  priceKzt       Decimal?       @db.Decimal(18, 2)
  priceCurrency  String         @default("KZT")
  regionId       String?
  region         Region?        @relation(fields: [regionId], references: [id])
  cityId         String?
  city           City?          @relation(fields: [cityId], references: [id])
  latitude       Float?
  longitude      Float?
  sellerType     SellerType     @default(PRIVATE)
  userId         String
  user           User           @relation(fields: [userId], references: [id])
  dealerId       String?
  dealer         Dealer?        @relation(fields: [dealerId], references: [id])
  params         Json?
  specs          Json?
  contactMasked  String?
  expiresAt      DateTime?
  publishedAt    DateTime?
  boostScore     Float          @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  media          Media[]
  favorites      Favorite[]
  conversations  Conversation[]

  @@index([status, categoryId])
  @@index([cityId])
  @@index([dealerId])
  @@index([createdAt])
}

model Media {
  id             String      @id @default(cuid())
  kind           MediaKind   @default(IMAGE)
  bucket         String
  objectKey      String
  url            String
  previewUrl     String?
  checksum       String?
  metadata       Json?
  listingId      String?
  listing        Listing?    @relation(fields: [listingId], references: [id])
  specialistId   String?
  specialist     Specialist? @relation(fields: [specialistId], references: [id])
  createdAt      DateTime    @default(now())

  @@index([listingId])
  @@index([specialistId])
}

model Specialist {
  id               String                    @id @default(cuid())
  userId           String?
  user             User?                     @relation(fields: [userId], references: [id])
  categoryId       String
  category         Category                  @relation(fields: [categoryId], references: [id])
  profession       String
  title            String
  bio              String?
  phone            String?
  experienceYears  Int                       @default(0)
  rateHourly       Decimal?                  @db.Decimal(12, 2)
  rateShift        Decimal?                  @db.Decimal(12, 2)
  rateMonthly      Decimal?                  @db.Decimal(12, 2)
  availability     SpecialistAvailability    @default(FULL_TIME)
  hasOwnEquipment  Boolean                   @default(false)
  certifications   Json?
  regionsServed    Json?
  skills           String[]
  languages        String[]                  @default([])
  rating           Float                     @default(0)
  reviewsCount     Int                       @default(0)
  regionId         String?
  region           Region?                   @relation(fields: [regionId], references: [id])
  cityId           String?
  city             City?                     @relation(fields: [cityId], references: [id])
  portfolio        Media[]
  reviews          Review[]
  favorites        Favorite[]
  conversations    Conversation[]
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt

  @@index([cityId])
  @@index([availability])
  @@index([rating])
}

model Review {
  id            String    @id @default(cuid())
  specialistId  String
  specialist    Specialist @relation(fields: [specialistId], references: [id])
  reviewerId    String
  reviewer      User      @relation("ReviewAuthor", fields: [reviewerId], references: [id])
  rating        Int
  comment       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([specialistId])
  @@index([rating])
}

model Favorite {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id])
  listingId     String?
  listing       Listing?     @relation(fields: [listingId], references: [id])
  specialistId  String?
  specialist    Specialist?  @relation(fields: [specialistId], references: [id])
  createdAt     DateTime     @default(now())

  @@unique([userId, listingId])
  @@unique([userId, specialistId])
}

model Conversation {
  id             String        @id @default(cuid())
  listingId      String?
  listing        Listing?      @relation(fields: [listingId], references: [id])
  specialistId   String?
  specialist     Specialist?   @relation(fields: [specialistId], references: [id])
  buyerId        String
  buyer          User          @relation("ConversationBuyer", fields: [buyerId], references: [id])
  sellerId       String
  seller         User          @relation("ConversationSeller", fields: [sellerId], references: [id])
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  messages       Message[]

  @@index([listingId])
  @@index([specialistId])
  @@index([buyerId, sellerId])
}

model Message {
  id              String       @id @default(cuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id])
  senderId        String
  sender          User         @relation(fields: [senderId], references: [id])
  body            String
  attachments     Json?
  createdAt       DateTime     @default(now())

  @@index([conversationId])
  @@index([senderId])
}

model PricingPlan {
  id           String           @id @default(cuid())
  code         PricingPlanCode
  title        String
  description  String?
  priceKzt     Int
  durationDays Int
  active       Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@unique([code])
}

model Wallet {
  id         String        @id @default(cuid())
  userId     String        @unique
  user       User          @relation(fields: [userId], references: [id])
  balanceKzt Int           @default(0)
  transactions Transaction[]
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
}

model Order {
  id           String         @id @default(cuid())
  userId       String
  user         User           @relation(fields: [userId], references: [id])
  status       OrderStatus    @default(PENDING)
  totalKzt     Int
  provider     BillingProvider @default(MOCK)
  paymentMode  String?
  metadata     Json?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  paidAt       DateTime?
  cancelledAt  DateTime?
  items        OrderItem[]
  transactions Transaction[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id           String               @id @default(cuid())
  orderId      String
  order        Order                @relation(fields: [orderId], references: [id])
  subjectType  PromotionSubjectType
  subjectId    String
  planCode     PricingPlanCode
  priceKzt     Int
  durationDays Int
  createdAt    DateTime             @default(now())
  activation   PromotionActivation? @relation("OrderItemActivation")

  @@index([orderId])
  @@index([subjectType, subjectId])
}

model Transaction {
  id         String           @id @default(cuid())
  walletId   String
  wallet     Wallet           @relation(fields: [walletId], references: [id])
  orderId    String?
  order      Order?           @relation(fields: [orderId], references: [id])
  type       TransactionType
  amountKzt  Int
  meta       Json?
  createdAt  DateTime         @default(now())

  @@index([walletId])
  @@index([orderId])
}

model PromotionActivation {
  id          String                    @id @default(cuid())
  subjectType PromotionSubjectType
  subjectId   String
  planCode    PricingPlanCode
  startedAt   DateTime
  expiresAt   DateTime
  orderItemId String?
  orderItem   OrderItem?                @relation("OrderItemActivation", fields: [orderItemId], references: [id])
  status      PromotionActivationStatus @default(ACTIVE)
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt

  @@index([subjectType, subjectId])
  @@index([expiresAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String?
  actor     User?    @relation(fields: [actorId], references: [id])
  action    String
  entity    String
  entityId  String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
}
